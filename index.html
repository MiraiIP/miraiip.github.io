<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Добавление VPN-подписки - CROL VPN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    color: #e8f7f4;
  }
  
  .container {
    max-width: 500px;
    width: 100%;
    background: #1a1a1a;
    border-radius: 20px;
    padding: 40px 30px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(32, 178, 170, 0.2);
    text-align: center;
  }
  
  .logo-container {
    margin-bottom: 30px;
  }
  
  .logo {
    width: 64px;
    height: 64px;
    margin: 0 auto 15px;
    background: transparent;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 24px rgba(32, 178, 170, 0.3);
  }
  
  h1 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 10px;
    background: linear-gradient(135deg, #20B2AA, #00CED1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .subtitle {
    font-size: 16px;
    color: #B0B0B0;
    margin-bottom: 30px;
  }
  
  .loading {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid rgba(32, 178, 170, 0.2);
    border-top-color: #20B2AA;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .status-text {
    font-size: 18px;
    color: #e8f7f4;
    margin-bottom: 30px;
    font-weight: 500;
  }
  
  .btn {
    display: inline-block;
    padding: 14px 28px;
    background: linear-gradient(135deg, #20B2AA, #00CED1);
    color: #0a0a0a;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(32, 178, 170, 0.3);
    margin: 8px;
    min-width: 200px;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(32, 178, 170, 0.4);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .btn-secondary {
    background: transparent;
    color: #20B2AA;
    border: 2px solid #20B2AA;
    box-shadow: none;
  }
  
  .btn-secondary:hover {
    background: rgba(32, 178, 170, 0.1);
  }
  
  #fallback-text, #store-link {
    margin-top: 20px;
    font-size: 14px;
    color: #B0B0B0;
  }
  
  #fallback-link {
    color: #20B2AA;
    text-decoration: none;
    word-break: break-all;
    font-size: 14px;
  }
  
  #fallback-link:hover {
    text-decoration: underline;
  }
  
  #store-url {
    color: #20B2AA;
    text-decoration: none;
  }
  
  #store-url:hover {
    text-decoration: underline;
  }
  
  .error {
    color: #ea4e43;
    margin-top: 20px;
  }
  
  @media (max-width: 480px) {
    .container {
      padding: 30px 20px;
    }
    
    h1 {
      font-size: 24px;
    }
    
    .btn {
      width: 100%;
      margin: 8px 0;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="logo-container">
    <div class="logo">
      <img src="https://raw.githubusercontent.com/MiraiIP/CROL_images/main/logo.png" alt="CROL VPN Logo" loading="lazy" style="width: 100%; height: 100%; object-fit: contain; border-radius: 20px; display: block;">
    </div>
    <h1>CROL VPN</h1>
    <p class="subtitle">Добавление VPN-подписки</p>
  </div>
  
  <div id="loading-container">
    <div class="loading"></div>
    <p class="status-text" id="status-text">Подключение к приложению…</p>
  </div>
  
  <div id="button-container" style="display:none;">
    <button id="add-config-btn" class="btn">Добавить конфигурацию</button>
  </div>
  
  <p id="fallback-text" style="display:none;">
    Если приложение не открылось автоматически, нажмите кнопку выше или ссылку ниже:
  </p>
  
  <p>
    <a id="fallback-link" href="#" style="display:none;">
      Добавить подписку
    </a>
  </p>
  
  <p id="store-link" style="display:none;">
    <a id="store-url" href="#">Установить приложение</a>
  </p>
  
  <div id="error-message" class="error" style="display:none;"></div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const app = params.get("app");
const key = params.get("key");

if (!app || !key) {
  document.getElementById("loading-container").style.display = "none";
  document.getElementById("error-message").style.display = "block";
  document.getElementById("error-message").textContent = "Ошибка: неверная ссылка. Вернитесь в бота и попробуйте снова.";
  throw new Error("Missing params");
}

const subUrl = "https://pr01.crol-dark.tech/sub/" + key;

// Конфигурация маршрутизации для Happ (base64)
const routingConfig = "ewogICAgIk5hbWUiOiAi8J+QsENST0wgVlBOIENvbmZpZyIsCiAgICAiR2xvYmFsUHJveHkiOiAidHJ1ZSIsCiAgICAiVXNlQ2h1bmtGaWxlcyI6ICJ0cnVlIiwKICAgICJSZW1vdGVETlNUeXBlIjogIkRvSCIsCiAgICAiUmVtb3RlRE5TRG9tYWluIjogImh0dHBzOi8vZG5zLmFkZ3VhcmQtZG5zLmNvbS9kbnMtcXVlcnkiLAogICAgIlJlbW90ZUROU0lQIjogIjk0LjE0MC4xNC4xNCIsCiAgICAiRG9tZXN0aWNETlNUeXBlIjogIkRvSCIsCiAgICAiRG9tZXN0aWNETlNEb21haW4iOiAiaHR0cHM6Ly9kbnMuYWRndWFyZC1kbnMuY29tL2Rucy1xdWVyeSIsCiAgICAiRG9tZXN0aWNETlNJUCI6ICI5NC4xNDAuMTUuMTUiLAogICAgIkdlb2lwdXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9mcmF5WlYvc2ltcGxlLXJ1LWdlb2lwL3JlbGVhc2VzL2xhdGVzdC9kb3dubG9hZC9nZW9pcC5kYXQiLAogICAgIkdlb3NpdGV1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2ZyYXlaVi9zaW1wbGUtcnUtZ2Vvc2l0ZS9yZWxlYXNlcy9sYXRlc3QvZG93bmxvYWQvZ2Vvc2l0ZS5kYXQiLAogICAgIkxhc3RVcGRhdGVkIjogIiIsCiAgICAiRG5zSG9zdHMiOiB7fSwKICAgICJSb3V0ZU9yZGVyIjogImJsb2NrLXByb3h5LWRpcmVjdCIsCiAgICAiRGlyZWN0U2l0ZXMiOiBbXSwKICAgICJEaXJlY3RJcCI6IFtdLAogICAgIlByb3h5U2l0ZXMiOiBbXSwKICAgICJQcm94eUlwIjogW10sCiAgICAiQmxvY2tTaXRlcyI6IFtdLAogICAgIkJsb2NrSXAiOiBbXSwKICAgICJEb21haW5TdHJhdGVneSI6ICJJUElmTm9uTWF0Y2giLAogICAgIkZha2VETlMiOiAiZmFsc2UiCn0=";

// Запуск кастомной схемы без выгрузки страницы.
// Это важно для Happ: если сделать window.location.href = happ://...,
// браузер часто "замораживает" JS после открытия приложения, и второй deeplink не успевает сработать.
function openCustomScheme(url) {
  // На некоторых iOS/Android браузерах вызов через iframe надежнее, чем location.href.
  const iframe = document.createElement("iframe");
  iframe.style.display = "none";
  iframe.src = url;
  document.body.appendChild(iframe);
  // Чистим iframe, чтобы не копить в DOM
  setTimeout(() => {
    try { document.body.removeChild(iframe); } catch (_) {}
  }, 1500);
}

function openDeepLink(url) {
  try {
    openCustomScheme(url);
  } catch (_) {
    // Фоллбек, если iframe запрещен
    window.location.href = url;
  }
}

let deepLink = null;
let routingLink = null;
let storeLink = null;
let deepLinkAlt = null;

switch(app){
  case "happ":
    // Для Happ: сначала маршрутизация, затем подписка
    routingLink = "happ://routing/add/" + routingConfig;
    // Happ (как ты описал) ожидает "сырой" URL прямо после happ://add/
    // Пример: happ://add/https://pr01.crol-dark.tech/sub/.....
    deepLink = "happ://add/" + subUrl;
    // Запасной вариант — закодированный URL (если в ключе встретятся символы, ломающие deeplink)
    deepLinkAlt = "happ://add/" + encodeURIComponent(subUrl);
    storeLink = /iphone|ipad/i.test(navigator.userAgent)
      ? "https://apps.apple.com/ru/app/happ-proxy-utility-plus/id6746188973"
      : "https://play.google.com/store/apps/details?id=com.happproxy";
    break;

  case "hiddify":
    deepLink = "hiddify://install-sub/?url=" + encodeURIComponent(subUrl);
    storeLink = /iphone|ipad/i.test(navigator.userAgent)
      ? "https://apps.apple.com/us/app/hiddify-proxy-vpn/id6596777532"
      : "https://play.google.com/store/apps/details?id=app.hiddify.com";
    break;

  case "singbox":
    deepLink = "sing-box://import-remote-profile?url=" + encodeURIComponent(subUrl);
    storeLink = /iphone|ipad/i.test(navigator.userAgent)
      ? "https://apps.apple.com/us/app/sing-box/id6451272673"
      : "https://play.google.com/store/apps/details?id=io.nekohasekai.sfa";
    break;

  case "streisand":
    deepLink = "streisand://import/" + encodeURIComponent(subUrl);
    storeLink = /iphone|ipad/i.test(navigator.userAgent)
      ? "https://apps.apple.com/us/app/streisand/id6450534064"
      : null;
    break;

  case "v2raytun":
    deepLink = "v2raytun://import/" + encodeURIComponent(subUrl) + "#CROL VPN";
    storeLink = "https://play.google.com/store/apps/details?id=com.v2raytun.android";
    break;

  case "v2box":
    deepLink = "v2box://install-sub?url=" + encodeURIComponent(subUrl) + "&name=CROL VPN";
    storeLink = /iphone|ipad/i.test(navigator.userAgent)
      ? "https://apps.apple.com/us/app/v2box-v2ray-client/id6446814690"
      : null;
    break;

  case "v2rayng":
    deepLink = "v2rayng://install-config?url=" + encodeURIComponent(subUrl) + "&name=CROL VPN";
    storeLink = "https://play.google.com/store/apps/details?id=com.v2ray.ang";
    break;

  case "cmfa":
    deepLink = "clash://install-config?url=" + encodeURIComponent(subUrl) + "&name=CROL VPN";
    storeLink = "https://play.google.com/store/apps/details?id=com.github.metacubex.clash.meta";
    break;

  default:
    document.getElementById("loading-container").style.display = "none";
    document.getElementById("error-message").style.display = "block";
    document.getElementById("error-message").textContent = "Ошибка: неизвестное приложение";
    throw new Error("Unknown app");
}

// Кнопка добавления конфигурации
const addConfigBtn = document.getElementById("add-config-btn");
addConfigBtn.addEventListener("click", function() {
  try {
    if (app === "happ" && routingLink) {
      // Для Happ: сначала маршрутизация, затем подписка
      // Важно: вызываем через iframe, чтобы страница не выгружалась и JS не замораживался.
      openDeepLink(routingLink);
      // Делаем небольшую задержку, но не слишком большую: браузер может уйти в фон.
      setTimeout(() => {
        openDeepLink(deepLink);
        // На некоторых связках (браузер/OS) "сырой" URL может быть отфильтрован —
        // пробуем альтернативу как мягкий фоллбек.
        if (deepLinkAlt) {
          setTimeout(() => openDeepLink(deepLinkAlt), 250);
        }
      }, 150);
    } else {
      openDeepLink(deepLink);
    }
  } catch(e) {
    console.error("Failed to open deep link:", e);
    document.getElementById("fallback-text").style.display = "block";
    document.getElementById("fallback-link").style.display = "inline";
  }
});

// Fallback — всегда чистый HTTPS
const fallbackText = document.getElementById("fallback-text");
const fallbackLink = document.getElementById("fallback-link");
fallbackLink.href = subUrl;

// Store
if(storeLink){
  const storeBlock = document.getElementById("store-link");
  const storeUrl = document.getElementById("store-url");
  storeUrl.href = storeLink;
  storeBlock.style.display = "block";
}

// Автопереход через небольшую задержку
setTimeout(() => {
  try {
    if (app === "happ" && routingLink) {
      // Для Happ: сначала маршрутизация, затем подписка
      openDeepLink(routingLink);
      setTimeout(() => {
        openDeepLink(deepLink);
        if (deepLinkAlt) {
          setTimeout(() => openDeepLink(deepLinkAlt), 250);
        }
        // Если переход не произошел через 1 секунду, показываем кнопку
        setTimeout(() => {
          document.getElementById("loading-container").style.display = "none";
          document.getElementById("button-container").style.display = "block";
          document.getElementById("status-text").textContent = "Нажмите кнопку для добавления конфигурации";
          document.getElementById("fallback-text").style.display = "block";
          document.getElementById("fallback-link").style.display = "inline";
        }, 1000);
      }, 150);
    } else {
      openDeepLink(deepLink);
      // Если переход не произошел через 1 секунду, показываем кнопку
      setTimeout(() => {
        document.getElementById("loading-container").style.display = "none";
        document.getElementById("button-container").style.display = "block";
        document.getElementById("status-text").textContent = "Нажмите кнопку для добавления конфигурации";
        document.getElementById("fallback-text").style.display = "block";
        document.getElementById("fallback-link").style.display = "inline";
      }, 1000);
    }
  } catch(e) {
    document.getElementById("loading-container").style.display = "none";
    document.getElementById("button-container").style.display = "block";
    document.getElementById("status-text").textContent = "Нажмите кнопку для добавления конфигурации";
    document.getElementById("fallback-text").style.display = "block";
    document.getElementById("fallback-link").style.display = "inline";
  }
}, 500);

</script>

</body>
</html>
